<template>
  <v-container>
    <h1>Skapa auktion</h1>
    <form @submit="handleSubmit">
       <v-text-field
               label="Titel"
               v-model="title"
               class="mt-4"
       ></v-text-field>
       <v-textarea
               name="Beskrivning"
               label="Beskrivning"
               v-model="description"
       ></v-textarea>
       <v-textarea
               name="Skick"
               label="Skick"
               v-model="auction_condition"
       ></v-textarea>
       <v-textarea
               name="Budstart"
               label="Budstart"
               placeholder="0"
               v-model="start_sum"
       ></v-textarea>
       <v-textarea
               name="Accepterat pris"
               label="Accepterat pris"
               placeholder="0"
               v-model="reserved_sum"
       ></v-textarea>
       <v-layout wrap align-center>
          <v-flex column xs12 sm6>
             <v-select
                     :items="category"
                     ref="selectedCategory"
                     label="Kategori"
             ></v-select>
          </v-flex>
       </v-layout>
      <div>
        <div id="postImage">
          <FileUpload @uploadImage="handleImage($event)"/>
        </div>
        <div v-if="previewImages[0]">
          <img v-for="image of previewImages" width="60%" :src="image" :key="image + 1" alt="profile picture">
        </div>
      </div>
      <div id="submitBtnDiv">
        <v-btn dark fab medium color="teal" id="submitBtn" type="submit">
          <v-icon dark large>add</v-icon>
        </v-btn>
      </div>
    </form>
  </v-container>
</template>

<script>
   import FileUpload from '@/components/FileUpload';
   import {eventBus} from "@/main";

  export default {
    components: {
      FileUpload
    },
    data() {
      return {
        previewImages: [],
        files: [],
        title: '',
        description: '',
         auction_condition: '',
         category: ['Fordon', 'Teknik', 'Konst', 'Hus', 'Inredning'],
         startingTime: new Date(Date.now()).getTime(),
         endingTime: new Date(Date.now()).getTime(),
         start_sum: 0,
         reserved_sum: 0,
         userId: this.$store.state.loggedInUserId
      }
    },
    computed: {},
     mounted() {
        eventBus.$on('uploadAuctionClicked', () => {
           console.log('Before handle submit');
           this.handleSubmit();
        });
     },
    methods: {
      async handleSubmit(e) {
        e.preventDefault()

        // if no input, don't submit
        if (!this.title.length || !this.description.length) {
          return;
        }

        let imagePaths = [];

        // send all images to server
        for (let file of this.files) {
          let fileData = new FormData();
          fileData.append('file', file)

          let response = await fetch('/api/upload', {
            method: 'POST',
            body: fileData
          })

          response = await response.text();

          console.log(response)
          imagePaths.push(response)

          // when all image paths has been received from
          // the server, a call to post is made
          if (imagePaths.length === this.files.length) {
            this.postAuction(imagePaths)
            this.$router.push({name: 'home'})
          }
        }
      },
      postAuction(imagePaths) {
        // let data = new FormData();
        // data.append('title', this.title);
        // data.append('description', this.description);
        // data.append('imagePaths', imagePaths);

        let data = {
           title: this.title,
           description: this.description,
           category: this.category[0],
           auction_condition: this.auction_condition,
           start_sum: this.start_sum,
           reserved_sum: this.reserved_sum,
           create_time: this.startingTime,
           end_time: this.endingTime,
           user_id: this.userId,
           imagePaths: imagePaths
        }

        fetch('/api/auctions', {
          method: 'POST',
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        })
            .then(res => {
              return res.json()
            })
            .then(res => {
              this.$store.commit('addAuction', res)
              this.$store.commit('filterItems')
            })
            .catch(e => console.log(e))
      },
      handleImage(imageData) {
        this.previewImages = imageData.previewImages
        this.files = imageData.files
      }
    }
  }
</script>

<style scoped>
  #submitBtnDiv {
    position: fixed;
    display: block;
    right: 20px;
    bottom: 70px;
  }

  .remove-btn {
    bottom: 80px;
  }

  #postTitle, #postInfo, #postImage {
    text-align: start;
    width: 80vw;
    display: flex;
    flex-direction: column;
    margin: 0 auto;
    padding: 0;
  }

  #postImage > h2 {
    display: inline-block;
  }

  h2 {
    padding: 0;
  }

  input {
    width: 100%;
    font-size: 1.1em;
  }

  textarea {
    width: 100%;
    font-size: 1.4em;
  }

  img {
    position: absolute;
    margin-top: -55px;
    right: 20px;
    background-color: whitesmoke;
  }
</style>